<p-card class="service-card">
    <ng-template pTemplate="header">
        <div class="flex items-center justify-between p-4 pb-0">
            <div class="flex items-center space-x-3">
                <i [class]="getService().icon + ' text-2xl text-primary'"></i>
                <h3 class="text-lg font-semibold m-0">{{ getService().displayName }}</h3>
            </div>
            <div class="flex space-x-2" *ngIf="!isLoading()">
                <p-tag *ngIf="serviceData?.hasRunningJobs" [value]="serviceData!.runningJobs.length.toString()" severity="info" [rounded]="true"> </p-tag>
                <p-tag *ngIf="serviceData?.hasRecentJobs" [value]="serviceData!.recentCompletedJobs.length.toString()" severity="secondary" [rounded]="true"> </p-tag>
            </div>
        </div>
    </ng-template>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="space-y-3">
        <div class="flex items-center space-x-2 mb-2">
            <p-skeleton shape="circle" size="2rem"></p-skeleton>
            <p-skeleton width="10rem" height="1rem"></p-skeleton>
        </div>
        <p-skeleton height="4rem" class="mb-2"></p-skeleton>
        <p-skeleton height="4rem"></p-skeleton>
    </div>

    <!-- Error State -->
    <div *ngIf="asyncState?.error" class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
        <div class="flex items-center space-x-2 text-red-600 dark:text-red-400">
            <i class="pi pi-exclamation-triangle"></i>
            <span class="text-sm">{{ asyncState!.error }}</span>
        </div>
    </div>

    <!-- Data Loaded State -->
    <ng-container *ngIf="!isLoading() && serviceData && !asyncState?.error">
        <!-- Running Jobs for this service -->
        <div *ngIf="serviceData.hasRunningJobs" class="mb-4">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="pi pi-play-circle mr-1"></i>
                Laufend ({{ serviceData.runningJobs.length }})
            </h4>
            <div class="space-y-2">
                <div *ngFor="let job of serviceData.runningJobs" class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-medium text-sm text-gray-900 dark:text-white">{{ job.name }}</h5>
                        <p-tag [value]="getJobStatusLabel(job.status)" [severity]="getJobStatusSeverity(job.status)" size="small"></p-tag>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">{{ getTimeAgo(job.startTime) }} • von {{ job.createdBy }}</div>
                    <div *ngIf="job.progress !== undefined">
                        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span>{{ job.progress }}%</span>
                            <span>{{ job.successCount }}/{{ job.totalItems }}</span>
                        </div>
                        <p-progressBar [value]="job.progress" [showValue]="false" class="h-1"></p-progressBar>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Jobs for this service -->
        <div *ngIf="serviceData.hasRecentJobs" class="mb-4">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="pi pi-check-circle mr-1"></i>
                Kürzlich abgeschlossen
            </h4>
            <div class="space-y-1">
                <div *ngFor="let job of serviceData.recentCompletedJobs" class="flex justify-between items-center p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-800">
                    <div>
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ job.name }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ getTimeAgo(job.endTime || job.startTime) }} • {{ job.successCount }}/{{ job.totalItems }}</div>
                    </div>
                    <p-tag [value]="getJobStatusLabel(job.status)" [severity]="getJobStatusSeverity(job.status)" size="small"></p-tag>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!serviceData.hasRunningJobs && !serviceData.hasRecentJobs" class="text-center py-6 text-gray-500 dark:text-gray-400">
            <i class="pi pi-inbox text-3xl mb-2"></i>
            <p class="text-sm">Keine aktuellen Jobs</p>
        </div>
    </ng-container>

    <!-- Service Actions - Always show action buttons -->
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex gap-2">
            <!-- Primary action: Create new job -->
            <p-button *ngIf="permissions.canCreateJobs" [label]="getServiceActionLabel(getService().name)" [icon]="'pi pi-plus'" size="small" class="flex-1" (onClick)="onNavigateToService(getService())" [pTooltip]="getService().description">
            </p-button>

            <!-- View all jobs action -->
            <p-button
                *ngIf="permissions.canViewJobs && serviceData"
                [label]="'Alle anzeigen'"
                [icon]="'pi pi-list'"
                size="small"
                severity="secondary"
                class="flex-1"
                (onClick)="onNavigateToService(serviceData!.service)"
                [pTooltip]="'Alle ' + serviceData!.service.displayName + ' Aufträge anzeigen'"
            >
            </p-button>
        </div>

        <!-- Status indicator when no jobs -->
        <div *ngIf="serviceData && !serviceData.hasRunningJobs && !serviceData.hasRecentJobs" class="text-center mt-3">
            <div class="flex items-center justify-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                <i [class]="serviceData.service.icon"></i>
                <span>Keine aktiven Aufträge</span>
            </div>
        </div>
    </div>
</p-card>
