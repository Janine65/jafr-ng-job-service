<div class="grid">
    <div class="col-12">
        <h3 class="mb-2">API Inspector</h3>
        <div class="mb-3">
            <p-button label="Clear Logs" icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="clearLogs()"></p-button>
        </div>
        <p-table [value]="logs" dataKey="id" responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3rem"></th>
                    <th style="width: 10%">Method</th>
                    <th>URL</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 12%">Duration</th>
                    <th style="width: 15%">Timestamp</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-log>
                <tr [ngClass]="getStatusClass(log.status)">
                    <td>
                        <button type="button" pButton pRipple (click)="toggleRow(log)" class="p-button-text p-button-rounded p-button-plain" [icon]="log.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                    </td>
                    <td>
                        <span [class]="'p-tag p-tag-' + getMethodSeverity(log.method)">{{ log.method }}</span>
                    </td>
                    <td class="font-mono text-sm">{{ log.url }}</td>
                    <td>
                        <span [class]="'p-tag p-tag-' + getStatusSeverity(log.status)">{{ log.status }}</span>
                    </td>
                    <td>{{ log.duration !== undefined ? log.duration + ' ms' : '-' }}</td>
                    <td class="text-sm">{{ formatTimestamp(log.timestamp) }}</td>
                </tr>
                <tr *ngIf="log.expanded">
                    <td colspan="6">
                        <div class="p-3 bg-gray-50">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <h5 class="mb-3 font-semibold">Request</h5>

                                    <div class="mb-3">
                                        <div class="flex justify-content-between align-items-center mb-2">
                                            <label class="font-semibold text-sm">Headers</label>
                                            <p-button
                                                icon="pi pi-eye"
                                                [label]="log.showRequestHeaders ? 'Hide' : 'Show'"
                                                (click)="log.showRequestHeaders = !log.showRequestHeaders"
                                                class="p-button-text p-button-sm"
                                                [severity]="log.showRequestHeaders ? 'secondary' : 'info'"
                                            >
                                            </p-button>
                                        </div>
                                        <pre *ngIf="log.showRequestHeaders" class="surface-card p-3 border-round text-sm max-h-300 overflow-auto">{{ prettyPrint(log.requestHeaders) }}</pre>
                                    </div>

                                    <div class="mb-3">
                                        <label class="font-semibold text-sm block mb-2">Body</label>
                                        <pre class="surface-card p-3 border-round text-sm max-h-300 overflow-auto">{{ prettyPrint(log.requestBody) }}</pre>
                                    </div>
                                </div>

                                <div class="col-12 md:col-6">
                                    <h5 class="mb-3 font-semibold">Response</h5>

                                    <div class="mb-3">
                                        <div class="flex justify-content-between align-items-center mb-2">
                                            <label class="font-semibold text-sm">Headers</label>
                                            <p-button
                                                icon="pi pi-eye"
                                                [label]="log.showResponseHeaders ? 'Hide' : 'Show'"
                                                (click)="log.showResponseHeaders = !log.showResponseHeaders"
                                                class="p-button-text p-button-sm"
                                                [severity]="log.showResponseHeaders ? 'secondary' : 'info'"
                                            >
                                            </p-button>
                                        </div>
                                        <pre *ngIf="log.showResponseHeaders" class="surface-card p-3 border-round text-sm max-h-300 overflow-auto">{{ prettyPrint(log.responseHeaders) }}</pre>
                                    </div>

                                    <div class="mb-3">
                                        <label class="font-semibold text-sm block mb-2">Body</label>
                                        <pre class="surface-card p-3 border-round text-sm max-h-300 overflow-auto">{{ prettyPrint(log.responseBody) }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6">No API calls logged yet.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<style>
    .max-h-300 {
        max-height: 300px;
    }
</style>
