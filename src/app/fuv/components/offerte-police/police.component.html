<!-- Blocking Loading Overlay -->
@if (isInitialDataLoading()) {
    <div class="fixed inset-0 z-[9999] bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 flex flex-col items-center gap-4 max-w-md">
            <p-progressSpinner [style]="{ width: '80px', height: '80px' }" strokeWidth="4" animationDuration="1s"> </p-progressSpinner>
            <div class="text-center">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Offerte wird geladen</h3>
                <p class="text-gray-600">Die Daten werden geladen. Dies kann einige Sekunden dauern...</p>
                <p class="text-sm text-gray-500 mt-2">Bitte warte einen Moment.</p>
            </div>
        </div>
    </div>
}

<div class="card">
    <!-- Title, Description and Buttons -->
    <div class="flex justify-between items-start mb-4">
        <!-- Left side: Title and Description -->
        <div class="flex-1">
            <h1 #scrollTarget class="text-2xl font-bold text-orange-500 mb-2">{{ 'fuv.police.title' | translate }}</h1>
            <p class="text-sm text-gray-700">{{ 'fuv.police.description' | translate }}</p>
        </div>

        <!-- Right side: Checklist button -->
        <div class="flex gap-2 ml-4 items-center">
            <button pButton type="button" [label]="'fuv.police.buttons.checkliste' | translate" icon="pi pi-check-square" [outlined]="true" [severity]="hasCheckliste() ? 'success' : 'secondary'" (click)="openChecklisteDialog()"></button>
        </div>
    </div>

    <!-- Policiert Banner (visible on all steps when offerte has been policiert) -->
    @if (isOffertePoliciert()) {
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4 flex items-start space-x-3">
            <i class="pi pi-check-circle text-green-500 text-xl mt-0.5"></i>
            <div class="flex-1">
                <h3 class="text-green-800 font-semibold text-base mb-1">{{ 'fuv.police.banners.policiert.title' | translate }}</h3>
                <p class="text-green-700 text-sm">{{ 'fuv.police.banners.policiert.description' | translate }}</p>
            </div>
        </div>
    }

    <!-- Rejection Banner (visible on all steps when offerte has ablehnungsgrund) -->
    @if (isOfferteRejected()) {
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 flex items-start space-x-3">
            <i class="pi pi-times-circle text-red-500 text-xl mt-0.5"></i>
            <div class="flex-1">
                <h3 class="text-red-800 font-semibold text-base mb-1">{{ 'fuv.police.banners.rejected.title' | translate }}</h3>
                <p class="text-red-700 text-sm">{{ 'fuv.police.banners.rejected.description' | translate }}</p>
            </div>
        </div>
    }

    <!-- Stepper Component -->
    <p-steps [model]="items" [(activeIndex)]="activeIndex" [readonly]="false"></p-steps>

    <!-- Step content -->
    <div class="step-content p-4 mt-2 surface-ground border-1 border-300 border-top-none">
        <ng-container [ngSwitch]="activeIndex">
            <app-versicherte-person *ngSwitchCase="0"></app-versicherte-person>
            <app-fuv-betrieb *ngSwitchCase="1"></app-fuv-betrieb>
            <app-taetigkeit *ngSwitchCase="2" [viewMode]="viewMode()" (defaultsApplied)="onTaetigkeitDefaultsApplied()"></app-taetigkeit>
            <app-varianten *ngSwitchCase="3" [viewMode]="viewMode()" (bbCalculated)="onBBCalculated()"></app-varianten>
            <app-antragsfragen *ngSwitchCase="4" [viewMode]="viewMode()" (vttCheckRequired)="onVttCheckComplete($event)"></app-antragsfragen>
            <app-abschluss *ngSwitchCase="5" [viewMode]="viewMode()" (printOffertantragRequested)="printOffertantrag()"></app-abschluss>
            <app-nachbearbeitung *ngSwitchCase="6" [viewMode]="viewMode()"></app-nachbearbeitung>
            <div *ngSwitchDefault>
                <p>{{ 'fuv.police.selectStep' | translate }}</p>
            </div>
        </ng-container>
    </div>

    <div class="flex justify-between items-center flex-wrap mt-4 w-full">
        <!-- Back button - Left side -->
        <button pButton type="button" icon="pi pi-arrow-left" [label]="'common.actions.back' | translate" (click)="prevStep()" [disabled]="activeIndex === 0" class="p-button-primary"></button>

        <!-- Middle space for conditional buttons -->
        <div class="flex gap-2">
            <!-- Close button - visible on every step -->
            <button pButton type="button" label="{{ 'fuv.police.buttons.schliessen' | translate }}" icon="pi pi-times" class="p-button-primary" (click)="close()"></button>

            <!-- Varianten buttons (step 3) -->
            <ng-container *ngIf="activeIndex === 3">
                <button pButton type="button" label="{{ 'fuv.police.buttons.unverbindlicheOfferteDrucken' | translate }}" icon="pi pi-print" class="p-button-info" (click)="printUnverbindlicheOfferte()"></button>
                <button
                    pButton
                    type="button"
                    [label]="printButtonLabelKey() | translate"
                    icon="pi pi-print"
                    class="p-button-info"
                    (click)="printOffertantrag()"
                    [disabled]="!hasCheckliste() || isVttRejected()"
                    [pTooltip]="
                        isVttRejected()
                            ? ('fuv.police.tooltips.offertantrag.vttRejected' | translate)
                            : !hasCheckliste()
                              ? ('fuv.police.tooltips.offertantrag.checklistMissing' | translate)
                              : ''
                    "
                    tooltipPosition="top"
                ></button>
            </ng-container>

            <!-- Abschluss button (step 5) -->
            <ng-container *ngIf="activeIndex === 5">
                <button
                    pButton
                    type="button"
                    [label]="printButtonLabelKey() | translate"
                    icon="pi pi-print"
                    class="p-button-info"
                    (click)="printOffertantrag()"
                    [disabled]="viewMode() || isVttRejected()"
                    [pTooltip]="isVttRejected() ? ('fuv.police.tooltips.offertantrag.vttRejected' | translate) : ''"
                    tooltipPosition="top"
                ></button>
            </ng-container>
        </div>

        <!-- Next button - Right side -->
        <button pButton type="button" icon="pi pi-arrow-right" iconPos="right" [label]="'common.actions.next' | translate" (click)="nextStep()" [disabled]="activeIndex === items.length - 1" class="p-button-primary"></button>
    </div>
</div>

<!-- Duplicate Offerte Warning Dialog -->
<p-dialog header="{{ 'fuv.police.duplicateDialog.title' | translate }}" [(visible)]="displayDuplicateDialog" [modal]="true" [style]="{ width: '500px' }" [closable]="false" [draggable]="false">
    <div class="flex flex-col gap-3">
        <div class="flex items-start gap-3">
            <i class="pi pi-exclamation-triangle text-orange-500 text-3xl"></i>
            <div>
                <p class="text-base mb-2">
                    {{ 'fuv.police.duplicateDialog.message' | translate }}
                </p>
                <p class="text-base font-semibold text-orange-600">{{ 'fuv.police.duplicateDialog.existingOfferte' | translate }}: {{ duplicateOffertenr }}</p>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton type="button" [label]="'common.actions.close' | translate" icon="pi pi-check" class="p-button-primary" (click)="closeDuplicateDialog()"></button>
    </ng-template>
</p-dialog>

<!-- Task Creation Dialog for Unverbindliche Offerte -->
<p-dialog header="Neue Aufgabe erstellen" [(visible)]="displayTaskDialog" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false" [style]="{ width: '50vw', minWidth: '600px' }" (onHide)="onTaskDialogCancel()">
    <div class="space-y-4 py-4">
        <!-- Aufgabeart -->
        <div class="flex flex-col gap-2">
            <label for="aufgabeart" class="font-medium text-gray-700">Aufgabeart</label>
            <p-select id="aufgabeart" [(ngModel)]="taskData.aufgabeart" [options]="aufgabenartOptions" optionLabel="label" optionValue="value" placeholder="Aufgabeart wählen" [style]="{ width: '100%' }" (onChange)="onAufgabenartChange()"></p-select>
        </div>

        <!-- Titel der Aufgabe -->
        <div class="flex flex-col gap-2">
            <label for="titel" class="font-medium text-gray-700">Titel der Aufgabe</label>
            <input pInputText id="titel" [(ngModel)]="taskData.titel" type="text" placeholder="Titel eingeben" class="w-full" />
        </div>

        <!-- Fällig am -->
        <div class="flex flex-col gap-2">
            <label for="faelligAm" class="font-medium text-gray-700">Fällig am</label>
            <input pInputText id="faelligAm" [(ngModel)]="taskData.faelligAm" type="text" placeholder="13.12.2025" class="w-full" />
        </div>

        <!-- Zugewiesen an -->
        <div class="flex flex-col gap-2">
            <label for="zugewiesenAn" class="font-medium text-gray-700">Zugewiesen an</label>
            <input pInputText id="zugewiesenAn" [(ngModel)]="taskData.zugewiesenAn" type="text" placeholder="Benutzername" class="w-full" />
        </div>

        <!-- Beschreibung -->
        <div class="flex flex-col gap-2">
            <label for="beschreibung" class="font-medium text-gray-700">Beschreibung</label>
            <textarea pTextarea id="beschreibung" [(ngModel)]="taskData.beschreibung" rows="4" placeholder="Beschreibung eingeben" class="w-full"></textarea>
        </div>

        <!-- Automatische Beschreibung (read-only) -->
        <div class="flex flex-col gap-2">
            <label for="automatischeBeschreibung" class="font-medium text-gray-700">Automatische Beschreibung</label>
            <textarea pTextarea id="automatischeBeschreibung" [(ngModel)]="taskData.automatischeBeschreibung" rows="4" [disabled]="true" class="w-full bg-gray-100"></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-center gap-3">
            <button pButton type="button" label="Aufgabe erstellen" icon="pi pi-check" class="p-button-primary" style="background-color: #00bcd4; border-color: #00bcd4" (click)="onTaskDialogSave()"></button>
            <button pButton type="button" label="Abbrechen" icon="pi pi-times" class="p-button-outlined" (click)="onTaskDialogCancel()"></button>
        </div>
    </ng-template>
</p-dialog>
