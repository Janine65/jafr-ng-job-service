<!-- Blocking Loading Overlay -->
@if (isLoading) {
    <div class="fixed inset-0 z-[9999] bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 flex flex-col items-center gap-4 max-w-md">
            <p-progressSpinner [style]="{ width: '80px', height: '80px' }" strokeWidth="4" animationDuration="1s"> </p-progressSpinner>
            <div class="text-center">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ 'fuv.police.checkliste.loading.title' | translate }}</h3>
                <p class="text-gray-600">{{ 'fuv.police.checkliste.loading.message' | translate }}</p>
                <p class="text-sm text-gray-500 mt-2">{{ 'fuv.police.checkliste.loading.pleaseWait' | translate }}</p>
            </div>
        </div>
    </div>
}

<div class="w-full">
    <div class="space-y-6">
        <form [formGroup]="checklisteForm" class="space-y-6">
            <!-- Gültig ab -->
            <div class="grid grid-cols-12 gap-4 items-center">
                <div class="col-span-4">
                    <label for="gueltig_ab" class="block text-sm font-medium text-gray-700">{{ 'common.police.gueltigAb' | translate }}</label>
                </div>
                <div class="col-span-8">
                    <p-datePicker formControlName="gueltig_ab" inputId="gueltig_ab" dateFormat="dd.mm.yy" class="w-full"></p-datePicker>
                </div>
            </div>

            <!-- Alter des Versicherten zu Vertragsbeginn -->
            <div class="grid grid-cols-12 gap-4 items-center border-t pt-6">
                <div class="col-span-4">
                    <label for="alter_versicherter" class="block text-sm font-medium text-gray-700">{{ 'fuv.police.checkliste.alterVersicherten' | translate }}</label>
                </div>
                <div class="col-span-6">
                    <input pInputText id="alter_versicherter" type="number" formControlName="alter_versicherter" class="w-full" />
                </div>
                <div class="col-span-2 flex justify-end">
                    <i [class]="'pi text-2xl ' + getAlterIcon()"></i>
                </div>
            </div>

            <!-- Rendement Section -->
            <div class="border-t pt-6">
                <div class="mb-4">
                    <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">{{ 'fuv.police.checkliste.sections.rendement' | translate }}</h3>
                </div>

                <!-- Mehr als ein Unfall -->
                <div class="grid grid-cols-12 gap-4 items-center mb-4">
                    <div class="col-span-10">
                        <div class="flex items-center">
                            <p-checkbox formControlName="anzahl_unfaelle" inputId="anzahl_unfaelle" [binary]="true"></p-checkbox>
                            <label for="anzahl_unfaelle" class="ml-2 text-sm text-gray-700">
                                {{ 'fuv.police.checkliste.rendement.mehrAlsEinUnfall' | translate }}
                                <span class="text-xs text-gray-500 ml-2">(Syrius: {{ backendAnzahlUnfaelle }})</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-span-2 flex justify-end">
                        <i [class]="'pi text-2xl ' + getAnzahlUnfaelleIcon()"></i>
                    </div>
                </div>

                <!-- Liegen laufende Unfälle vor -->
                <div class="grid grid-cols-12 gap-4 items-center mb-4">
                    <div class="col-span-10">
                        <div class="flex items-center">
                            <p-checkbox formControlName="laufende_unfaelle" inputId="laufende_unfaelle" [binary]="true"></p-checkbox>
                            <label for="laufende_unfaelle" class="ml-2 text-sm text-gray-700">
                                {{ 'fuv.police.checkliste.rendement.liegenLaufendeUnfaelleVor' | translate }}
                                <span class="text-xs text-gray-500 ml-2">(Syrius: {{ backendLaufendeUnfaelle }})</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-span-2 flex justify-end">
                        <i [class]="'pi text-2xl ' + getLaufendeUnfaelleIcon()"></i>
                    </div>
                </div>

                <!-- Description text -->
                <div class="col-span-12 mt-2">
                    <p class="text-xs text-gray-500 italic">{{ 'fuv.police.checkliste.rendement.description' | translate }}</p>
                </div>
            </div>

            <!-- Bonität aus CRIF -->
            <div class="border-t pt-6">
                <div class="grid grid-cols-12 gap-4 items-start mb-4">
                    <div class="col-span-4">
                        <label for="bonitaet_crif" class="block text-sm font-medium text-gray-700">{{ 'fuv.police.checkliste.bonitaetCrif.title' | translate }}</label>
                    </div>
                    <div class="col-span-8">
                        <div class="flex gap-2 items-center mb-4">
                            <p-select formControlName="bonitaet_crif" inputId="bonitaet_crif" [options]="bonitaetOptions" [placeholder]="'fuv.police.checkliste.bonitaetCrif.selectPlaceholder' | translate" class="w-full" [showClear]="true"></p-select>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button pButton type="button" [label]="'fuv.police.checkliste.buttons.callCrif' | translate" class="p-button-outlined p-button-info flex-1" (click)="onCrifAufrufen()" [disabled]="isLoading" icon="pi pi-search"></button>
                            <button pButton type="button" [label]="'fuv.police.checkliste.buttons.fetchCrifData' | translate" class="p-button-outlined p-button-info flex-1" (click)="onCrifDatenAbrufen()" [disabled]="isLoading" icon="pi pi-download"></button>
                        </div>
                        <div class="mt-3 space-y-2">
                            <button
                                pButton
                                type="button"
                                [label]="'fuv.police.checkliste.buttons.downloadCrifPdf' | translate"
                                class="p-button-outlined p-button-secondary w-full"
                                (click)="onCrifReportPdfDownload()"
                                [disabled]="isLoading || !crifArchivingId"
                                icon="pi pi-file-pdf"
                            ></button>
                            <button
                                pButton
                                type="button"
                                [label]="'fuv.police.checkliste.buttons.openCrifWeb' | translate"
                                class="p-button-outlined p-button-secondary w-full"
                                (click)="onCrifReportWebOpen()"
                                [disabled]="isLoading || !crifArchivingId"
                                icon="pi pi-external-link"
                            ></button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">{{ 'fuv.police.checkliste.messages.crifAvailability' | translate }}</p>
                    </div>
                </div>
            </div>

            <!-- Audit -->
            <div class="border-t pt-6">
                <div class="mb-4">
                    <h3 class="text-base font-semibold text-gray-900">{{ 'common.partner.audit' | translate }}</h3>
                </div>
                <div class="grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-10">
                        <div class="flex items-center">
                            <p-checkbox formControlName="audit" inputId="audit" [binary]="true"></p-checkbox>
                            <label for="audit" class="ml-2 text-sm text-gray-700">{{ 'fuv.police.checkliste.audit.auditFlagCrifVorhanden' | translate }}</label>
                        </div>
                    </div>
                    <div class="col-span-2 flex justify-end">
                        <i [class]="'pi text-2xl ' + getAuditIcon()"></i>
                    </div>
                </div>
            </div>
        </form>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center pt-6 border-t">
            <button pButton type="button" [label]="'fuv.police.checkliste.buttons.save' | translate" icon="pi pi-save" class="p-button-info" (click)="onSave()" [loading]="isLoading"></button>
            <div class="flex gap-2">
                <button pButton type="button" [label]="'fuv.police.actions.print' | translate" icon="pi pi-print" class="p-button-outlined" (click)="onPrint()" [disabled]="!checklisteId || isLoading"></button>
                <button pButton type="button" [label]="'fuv.police.checkliste.buttons.createVttTask' | translate" icon="pi pi-envelope" class="p-button-outlined" (click)="onAufgabeVttErstellen()" [disabled]="isLoading"></button>
            </div>
        </div>
    </div>

    <!-- Task Creation Form Dialog -->
    <p-dialog header="Neue Aufgabe erstellen" [(visible)]="showTaskCreationDialog" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false" [style]="{ width: '50vw', minWidth: '600px' }" (onHide)="onTaskCreationCancel()">
        <div class="space-y-4 py-4">
            <!-- Aufgabeart -->
            <div class="flex flex-col gap-2">
                <label for="aufgabeart" class="font-medium text-gray-700">Aufgabeart</label>
                <p-select id="aufgabeart" [(ngModel)]="taskData.aufgabeart" [options]="aufgabenartOptions" optionLabel="label" optionValue="value" [style]="{ width: '100%' }" [showClear]="true" (onChange)="onAufgabenartChange()"></p-select>
            </div>

            <!-- Titel der Aufgabe -->
            <div class="flex flex-col gap-2">
                <label for="titel" class="font-medium text-gray-700">Titel der Aufgabe</label>
                <input pInputText id="titel" [(ngModel)]="taskData.titel" class="w-full" style="border-color: #00bcd4" />
            </div>

            <!-- Fällig am -->
            <div class="flex flex-col gap-2">
                <label for="faelligAm" class="font-medium text-gray-700">Fällig am</label>
                <input pInputText id="faelligAm" [(ngModel)]="taskData.faelligAm" class="w-full" placeholder="dd.mm.yyyy" />
            </div>

            <!-- Zugewiesen an -->
            <div class="flex flex-col gap-2">
                <label for="zugewiesenAn" class="font-medium text-gray-700">Zugewiesen an</label>
                <input pInputText id="zugewiesenAn" [(ngModel)]="taskData.zugewiesenAn" class="w-full" placeholder="cst" />
            </div>

            <!-- Beschreibung -->
            <div class="flex flex-col gap-2">
                <label for="beschreibung" class="font-medium text-gray-700">Beschreibung</label>
                <textarea pInputTextarea id="beschreibung" [(ngModel)]="taskData.beschreibung" rows="4" class="w-full"></textarea>
            </div>

            <!-- Automatische Beschreibung -->
            <div class="flex flex-col gap-2">
                <label for="automatischeBeschreibung" class="font-medium text-gray-700">Automatische Beschreibung</label>
                <textarea pInputTextarea id="automatischeBeschreibung" [(ngModel)]="taskData.automatischeBeschreibung" rows="6" class="w-full bg-gray-50" [readonly]="true"></textarea>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-start gap-2">
                <button pButton type="button" label="Aufgabe erstellen" class="p-button-primary" style="background-color: #00bcd4; border-color: #00bcd4" (click)="onTaskCreationSave()"></button>
            </div>
        </ng-template>
    </p-dialog>
</div>
