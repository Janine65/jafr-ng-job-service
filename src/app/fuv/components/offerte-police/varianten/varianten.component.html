<div class="w-full">
    <p-panel header="{{ 'fuv.police.steps.varianten' | translate }}" [toggleable]="false">
        <!-- Invalid Zahlungsweise warning banner -->
        <div *ngIf="invalidZahlungsweiseWarning()" class="mb-6 p-4 bg-yellow-50 border border-yellow-300 rounded-md">
            <div class="flex items-start gap-3">
                <i class="pi pi-exclamation-triangle text-yellow-600 text-xl mt-0.5"></i>
                <div>
                    <p class="text-sm font-semibold text-yellow-800 mb-1">{{ 'core.interceptors.error.timeout.summary' | translate }}</p>
                    <p class="text-sm text-yellow-700">{{ invalidZahlungsweiseWarning() }}</p>
                </div>
            </div>
        </div>

        <!-- Validation error banner -->
        <div #validationErrorBanner *ngIf="showValidation() && !isStepValid()" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-md" tabindex="-1">
            <div class="flex items-start gap-3">
                <i class="pi pi-exclamation-triangle text-red-600 text-xl mt-0.5"></i>
                <div>
                    <p class="text-sm font-semibold text-red-800 mb-1">{{ 'fuv.police.varianten.validation.requiredFields' | translate }}</p>
                    <ul class="text-sm text-red-700 list-disc list-inside space-y-1">
                        <li *ngIf="!variantenData.selectedVariante">{{ 'fuv.police.varianten.validation.varianteMissing' | translate }}</li>
                        <li *ngIf="hasSelectedVarianteError('verdienst')">
                            {{ 'fuv.police.varianten.validation.verdienstMissing' | translate: { variant: variantenData.selectedVariante } }}
                            <span *ngIf="getSelectedVarianteError()" class="block ml-4 mt-1">{{ getSelectedVarianteError() }}</span>
                        </li>
                        <li *ngIf="hasSelectedVarianteError('taggeld')">{{ 'fuv.police.varianten.validation.taggeldMissing' | translate: { variant: variantenData.selectedVariante } }}</li>
                        <li *ngIf="hasFieldError('praemienzahlung')">{{ 'fuv.police.varianten.validation.praemienzahlungMissing' | translate }}</li>
                        <li *ngIf="variantenData.praemienzahlung && variantenData.praemienzahlung !== 'jaehrlich' && !currentOfferte()?.checkliste?.id">
                            {{ 'fuv.police.varianten.validation.checklisteRequired' | translate }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            <!-- Loading State -->
            @if (isCalculating()) {
                <div class="text-center py-8">
                    <i class="pi pi-spin pi-spinner text-4xl text-primary-500 mb-4"></i>
                    <p class="text-lg font-medium text-gray-700">{{ 'fuv.police.varianten.loading.title' | translate }}</p>
                    <p class="text-sm text-gray-500 mt-2">{{ 'fuv.police.varianten.loading.message' | translate }}</p>
                </div>
            }

            <!-- Error State -->
            @if (calculationError() && !isCalculating()) {
                <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-md">
                    <div class="flex">
                        <i class="pi pi-exclamation-triangle text-red-500 text-xl mr-3"></i>
                        <div>
                            <h4 class="text-red-800 font-semibold mb-1">{{ 'fuv.police.varianten.error.calculationTitle' | translate }}</h4>
                            <p class="text-red-700 text-sm">{{ calculationError() }}</p>
                            <button pButton [label]="'fuv.police.varianten.error.retryButton' | translate" icon="pi pi-refresh" class="p-button-sm p-button-danger mt-3" [disabled]="viewMode" (click)="calculateTechnischeZuweisung()"></button>
                        </div>
                    </div>
                </div>
            }

            <!-- Technische Zuweisung Details -->
            <div>
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.technischeZuweisung.title' | translate }}</h3>
                <p-table [value]="technischeZuweisungen" class="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.zuweisungstyp' | translate }}</th>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.anteil' | translate }}</th>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.klasse' | translate }}</th>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.bezeichnungKlasse' | translate }}</th>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.unterklassenteil' | translate }}</th>
                            <th>{{ 'fuv.police.varianten.technischeZuweisung.table.bezeichnungUnterklassenteil' | translate }}</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-item>
                        <tr>
                            <td>{{ getZuweisungstyp(item.zuweisungstyp) }}</td>
                            <td>{{ item.anteil }}</td>
                            <td>{{ item.klasse }}</td>
                            <td>{{ item.bezeichnungKlasse }}</td>
                            <td>{{ item.unterklassenteil }}</td>
                            <td>{{ item.bezeichnungUnterklassenteil }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Grundlagen für die Prämienberechnung -->
            @if (technischeZuweisungen.length > 0) {
                <div>
                    <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.grundlagen.title' | translate }}</h3>
                    <div class="grid grid-cols-5 gap-4 items-end">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.grundlagen.agenturkompetenz' | translate }}</label>
                            <p-select
                                [options]="agenturkompetenzOptions()"
                                optionLabel="label"
                                optionValue="value"
                                [(ngModel)]="variantenData.agenturkompetenz"
                                [placeholder]="'common.placeholders.pleaseSelect' | translate"
                                [showClear]="false"
                                [appendTo]="'body'"
                                class="w-full"
                                [disabled]="viewMode"
                                [invalid]="hasFieldError('agenturkompetenz') || isTopLevelFieldEmpty('agenturkompetenz')"
                                [ngClass]="{ '!border-orange-500': isTopLevelFieldEmpty('agenturkompetenz') }"
                                (onChange)="onAgenturkompetenzChange()"
                            >
                            </p-select>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'common.partner.klasse' | translate }}</label>
                            <input pInputText [(ngModel)]="variantenData.klasse" [fluid]="true" [disabled]="true" class="text-cyan-600" (ngModelChange)="onDataChange()" />
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'common.partner.basisstufe' | translate }}</label>
                            <input pInputText [ngModel]="basisstufeSignal()" [fluid]="true" [disabled]="true" class="text-cyan-600" />
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'common.partner.stufe' | translate }}</label>
                            <input pInputText [ngModel]="calculatedStufe()" [fluid]="true" [disabled]="true" class="text-cyan-600" />
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.praemiensatzBrutto' | translate }}</label>
                            <input pInputText [ngModel]="formattedPraemiensatzBrutto()" [fluid]="true" [disabled]="true" class="text-cyan-600" />
                        </div>
                    </div>
                </div>
            }

            <!-- Varianten, Geldleistungen, Prämienübersicht grouped -->
            <div class="border-t pt-6">
                <!-- Variant Chooser -->
                <div class="grid grid-cols-3 gap-x-16 mb-6">
                    <div
                        class="flex items-center justify-center space-x-2 px-4 py-3 border rounded-lg transition-colors"
                        [class.border-green-500]="variantenData.selectedVariante === 'A'"
                        [class.bg-green-50]="variantenData.selectedVariante === 'A'"
                        [class.border-orange-500]="hasFieldError('selectedVariante')"
                        [class.cursor-pointer]="!viewMode"
                        [class.hover:bg-gray-50]="!viewMode"
                        (click)="!viewMode && toggleVarianteSelection('A')"
                    >
                        <p-radioButton name="variante" value="A" [(ngModel)]="variantenData.selectedVariante" [disabled]="viewMode" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-base font-semibold cursor-pointer">{{ 'fuv.police.varianten.labels.varianteA' | translate }}</label>
                    </div>
                    <div
                        class="flex items-center justify-center space-x-2 px-4 py-3 border rounded-lg transition-colors"
                        [class.border-green-500]="variantenData.selectedVariante === 'B'"
                        [class.bg-green-50]="variantenData.selectedVariante === 'B'"
                        [class.border-orange-500]="hasFieldError('selectedVariante')"
                        [class.cursor-pointer]="!viewMode"
                        [class.hover:bg-gray-50]="!viewMode"
                        (click)="!viewMode && toggleVarianteSelection('B')"
                    >
                        <p-radioButton name="variante" value="B" [(ngModel)]="variantenData.selectedVariante" [disabled]="viewMode" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-base font-semibold cursor-pointer">{{ 'fuv.police.varianten.labels.varianteB' | translate }}</label>
                    </div>
                    <div
                        class="flex items-center justify-center space-x-2 px-4 py-3 border rounded-lg transition-colors"
                        [class.border-green-500]="variantenData.selectedVariante === 'C'"
                        [class.bg-green-50]="variantenData.selectedVariante === 'C'"
                        [class.border-orange-500]="hasFieldError('selectedVariante')"
                        [class.cursor-pointer]="!viewMode"
                        [class.hover:bg-gray-50]="!viewMode"
                        (click)="!viewMode && toggleVarianteSelection('C')"
                    >
                        <p-radioButton name="variante" value="C" [(ngModel)]="variantenData.selectedVariante" [disabled]="viewMode" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-base font-semibold cursor-pointer">{{ 'fuv.police.varianten.labels.varianteC' | translate }}</label>
                    </div>
                </div>

                <div class="grid gap-x-4" style="grid-template-columns: 1fr auto 1fr auto 1fr">
                    <!-- Variante A -->
                    <div class="space-y-4 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'A'">
                        <!-- Jahresverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input
                                    pInputText
                                    appNumberFormat
                                    [(ngModel)]="variantenData.varianteA.verdienst"
                                    class="!rounded-l-none"
                                    [ngClass]="{
                                        '!border-red-500': showValidation() && varianteAError() && variantenData.selectedVariante === 'A',
                                        '!border-orange-500': !varianteAError() && (variantenData.varianteA.verdienst === '0' || !variantenData.varianteA.verdienst)
                                    }"
                                    [fluid]="true"
                                    [disabled]="viewMode"
                                    (ngModelChange)="onVerdienstChange('varianteA')"
                                />
                            </div>
                            @if (varianteAError() && variantenData.selectedVariante === 'A') {
                                <p #errorMessageA class="text-xs text-red-600 mt-1">{{ varianteAError() }}</p>
                            }
                        </div>

                        <!-- Monatsverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatsverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.monatsverdienst" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>

                        <!-- Taggeld ab -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldAb' | translate }}</label>
                            <p-select
                                [options]="taggeldOptions()"
                                optionLabel="label"
                                optionValue="value"
                                [(ngModel)]="variantenData.varianteA.taggeld"
                                [placeholder]="'fuv.police.varianten.placeholders.taggeldAbWaehlen' | translate"
                                [fluid]="true"
                                [disabled]="viewMode"
                                [invalid]="hasError('varianteA', 'taggeld') || isVarianteFieldEmpty('varianteA', 'taggeld')"
                                [ngClass]="{ '!border-orange-500': isVarianteFieldEmpty('varianteA', 'taggeld') }"
                                (onChange)="onTaggeldChange('varianteA')"
                            >
                            </p-select>
                        </div>
                        <!-- Rabatt -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <input pInputText [(ngModel)]="variantenData.varianteA.taggeldaufschubrabatt" class="!rounded-r-none text-cyan-600" [fluid]="true" [disabled]="true" />
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-l-0 border-gray-300 rounded-r-md">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Copy Buttons Column -->
                    <div class="flex flex-col items-center justify-start space-y-4">
                        <!-- Align with Jahresverdienst input field center -->
                        <div class="h-[28px]"></div>
                        <button
                            pButton
                            type="button"
                            icon="pi pi-arrow-right"
                            class="p-button-sm p-button-outlined"
                            [disabled]="viewMode"
                            (click)="copyVerdienst()"
                            [pTooltip]="'fuv.police.varianten.tooltips.copyToVariants' | translate"
                            tooltipPosition="right"
                        ></button>
                        <!-- Space for Monatsverdienst field -->
                        <div class="h-[90px]"></div>
                        <button
                            pButton
                            type="button"
                            icon="pi pi-arrow-right"
                            class="p-button-sm p-button-outlined"
                            [disabled]="viewMode"
                            (click)="copyTaggeld()"
                            [pTooltip]="'fuv.police.varianten.tooltips.copyToVariants' | translate"
                            tooltipPosition="right"
                        ></button>
                    </div>

                    <!-- Variante B -->
                    <div class="space-y-4 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'B'">
                        <!-- Jahresverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input
                                    pInputText
                                    appNumberFormat
                                    [(ngModel)]="variantenData.varianteB.verdienst"
                                    class="!rounded-l-none"
                                    [ngClass]="{
                                        '!border-red-500': showValidation() && varianteBError() && variantenData.selectedVariante === 'B',
                                        '!border-orange-500': !varianteBError() && (variantenData.varianteB.verdienst === '0' || !variantenData.varianteB.verdienst)
                                    }"
                                    [fluid]="true"
                                    [disabled]="viewMode"
                                    (ngModelChange)="onVerdienstChange('varianteB')"
                                />
                            </div>
                            @if (varianteBError() && variantenData.selectedVariante === 'B') {
                                <p class="text-xs text-red-600 mt-1">{{ varianteBError() }}</p>
                            }
                        </div>

                        <!-- Monatsverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatsverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.monatsverdienst" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>

                        <!-- Taggeld ab -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldAb' | translate }}</label>
                            <p-select
                                [options]="taggeldOptions()"
                                optionLabel="label"
                                optionValue="value"
                                [(ngModel)]="variantenData.varianteB.taggeld"
                                [placeholder]="'fuv.police.varianten.placeholders.taggeldAbWaehlen' | translate"
                                [fluid]="true"
                                [disabled]="viewMode"
                                [invalid]="hasError('varianteB', 'taggeld') || isVarianteFieldEmpty('varianteB', 'taggeld')"
                                [ngClass]="{ '!border-orange-500': isVarianteFieldEmpty('varianteB', 'taggeld') }"
                                (onChange)="onTaggeldChange('varianteB')"
                            >
                            </p-select>
                        </div>

                        <!-- Rabatt -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <input pInputText [(ngModel)]="variantenData.varianteB.taggeldaufschubrabatt" class="!rounded-r-none text-cyan-600" [fluid]="true" [disabled]="true" />
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-l-0 border-gray-300 rounded-r-md">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Empty Spacer Column -->
                    <div></div>

                    <!-- Variante C -->
                    <div class="space-y-4 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'C'">
                        <!-- Jahresverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input
                                    pInputText
                                    appNumberFormat
                                    [(ngModel)]="variantenData.varianteC.verdienst"
                                    class="!rounded-l-none"
                                    [ngClass]="{
                                        '!border-red-500': showValidation() && varianteCError() && variantenData.selectedVariante === 'C',
                                        '!border-orange-500': !varianteCError() && (variantenData.varianteC.verdienst === '0' || !variantenData.varianteC.verdienst)
                                    }"
                                    [fluid]="true"
                                    [disabled]="viewMode"
                                    (ngModelChange)="onVerdienstChange('varianteC')"
                                />
                            </div>
                            @if (varianteCError() && variantenData.selectedVariante === 'C') {
                                <p class="text-xs text-red-600 mt-1">{{ varianteCError() }}</p>
                            }
                        </div>

                        <!-- Monatsverdienst -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatsverdienst' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.monatsverdienst" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>

                        <!-- Taggeld ab -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldAb' | translate }}</label>
                            <p-select
                                [options]="taggeldOptions()"
                                optionLabel="label"
                                optionValue="value"
                                [(ngModel)]="variantenData.varianteC.taggeld"
                                [placeholder]="'fuv.police.varianten.placeholders.taggeldAbWaehlen' | translate"
                                [fluid]="true"
                                [disabled]="viewMode"
                                [invalid]="hasError('varianteC', 'taggeld') || isVarianteFieldEmpty('varianteC', 'taggeld')"
                                [ngClass]="{ '!border-orange-500': isVarianteFieldEmpty('varianteC', 'taggeld') }"
                                (onChange)="onTaggeldChange('varianteC')"
                            >
                            </p-select>
                        </div>

                        <!-- Rabatt -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <input pInputText [(ngModel)]="variantenData.varianteC.taggeldaufschubrabatt" class="!rounded-r-none text-cyan-600" [fluid]="true" [disabled]="true" />
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-l-0 border-gray-300 rounded-r-md">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geldleistungen Section -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.labels.geldleistungen' | translate }}</h3>
                <div class="grid grid-cols-3 gap-x-16">
                    <!-- Variante A -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'A'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProJahr' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.taggeldj" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProMonat' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.taggeldm" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProJahr' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.ivrentej" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProMonat' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.ivrentem" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>

                    <!-- Variante B -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'B'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProJahr' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.taggeldj" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProMonat' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.taggeldm" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProJahr' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.ivrentej" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProMonat' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.ivrentem" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>

                    <!-- Variante C -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'C'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProJahr' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.taggeldj" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.taggeldProMonat' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.taggeldm" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProJahr' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.ivrentej" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.invalidenrenteProMonat' | translate }}</label>
                            <label class="text-xs text-gray-500">{{ 'fuv.police.varianten.labels.invalidenrenteHinweis' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.ivrentem" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 px-4">
                    <p class="text-sm text-gray-600">&ast; {{ 'fuv.police.varianten.labels.invalidenrenteKuerzung' | translate }}</p>
                </div>
            </div>

            <!-- Prämienübersicht (grouped under variants) -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.labels.praemienUebersicht' | translate }}</h3>
                <div class="grid grid-cols-3 gap-x-16">
                    <!-- Variante A -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'A'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresbruttoprämie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.jahrespraemie_ohne_rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahrespraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.jahrespraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatspraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteA.nettopraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>

                    <!-- Variante B -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'B'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresbruttoprämie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.jahrespraemie_ohne_rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahrespraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.jahrespraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatspraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteB.nettopraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>

                    <!-- Variante C -->
                    <div class="space-y-3 px-4 py-4 rounded-lg transition-colors" [class.bg-green-50]="variantenData.selectedVariante === 'C'">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahresbruttoprämie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.jahrespraemie_ohne_rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.rabatt' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.rabatt" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.jahrespraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.jahrespraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.monatspraemie' | translate }}</label>
                            <div class="flex">
                                <span class="flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">CHF</span>
                                <input pInputText appNumberFormat [(ngModel)]="variantenData.varianteC.nettopraemie" class="!rounded-l-none text-cyan-600" [fluid]="true" [disabled]="true" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 px-4">
                    <p class="text-sm text-gray-600">&ast; {{ 'fuv.police.varianten.labels.minimalpraemie' | translate }}</p>
                </div>
            </div>

            <!-- Prämienzahlung -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.praemienzahlung.label' | translate }}</h3>

                @if (!currentOfferte()?.checkliste) {
                    <div class="mb-4 p-3 bg-orange-50 border-l-4 border-orange-500 text-orange-700">
                        <p class="text-sm">
                            <i class="pi pi-exclamation-triangle mr-2"></i>
                            {{ 'fuv.police.varianten.labels.checklisteZahlungsweise' | translate }}
                        </p>
                    </div>
                }

                <div class="flex space-x-8 p-3 border rounded-lg transition-colors" [class.border-red-500]="hasFieldError('praemienzahlung')" [class.bg-red-50]="hasFieldError('praemienzahlung')">
                    <div class="flex items-center space-x-2 cursor-pointer" (click)="!viewMode && togglePraemienzahlung('jaehrlich')">
                        <p-radioButton name="praemienzahlung" value="jaehrlich" [(ngModel)]="variantenData.praemienzahlung" [disabled]="viewMode" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-sm cursor-pointer">{{ 'fuv.police.varianten.zahlungsweiseLabels.jaehrlich' | translate }}</label>
                    </div>
                    <div class="flex items-center space-x-2 cursor-pointer" (click)="!viewMode && (!currentOfferte()?.checkliste || togglePraemienzahlung('halbjaehrlich'))">
                        <p-radioButton name="praemienzahlung" value="halbjaehrlich" [(ngModel)]="variantenData.praemienzahlung" [disabled]="viewMode || !currentOfferte()?.checkliste" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-sm cursor-pointer" [class.text-gray-400]="!currentOfferte()?.checkliste">{{ 'fuv.police.varianten.zahlungsweiseLabels.halbjaehrlich' | translate }}</label>
                    </div>
                    <div class="flex items-center space-x-2 cursor-pointer" (click)="!viewMode && (!currentOfferte()?.checkliste || togglePraemienzahlung('vierteljaehrlich'))">
                        <p-radioButton name="praemienzahlung" value="vierteljaehrlich" [(ngModel)]="variantenData.praemienzahlung" [disabled]="viewMode || !currentOfferte()?.checkliste" (click)="$event.preventDefault()"> </p-radioButton>
                        <label class="text-sm cursor-pointer" [class.text-gray-400]="!currentOfferte()?.checkliste">{{ 'fuv.police.varianten.zahlungsweiseLabels.vierteljaehrlich' | translate }}</label>
                    </div>
                </div>
            </div>

            <!-- Zahlungsadresse -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.labels.zahlungsadresse' | translate }}</h3>
                <div class="space-y-4">
                    <!-- IBAN -->
                    <div class="space-y-1">
                        <label for="iban" class="block text-sm font-medium text-gray-600">
                            {{ 'fuv.police.varianten.labels.ibanNr' | translate }}
                            <span *ngIf="isLoadingBank()" class="text-xs text-gray-500 ml-2">({{ 'fuv.police.varianten.labels.bankLookupInProgress' | translate }})</span>
                        </label>
                        <input pInputText id="iban" [(ngModel)]="variantenData.iban" class="w-[600px] text-cyan-600" (ngModelChange)="onIbanChange()" placeholder="CH13 0077 8180 2388 9200" autocomplete="off" [disabled]="viewMode" />
                        <!-- IBAN validation error message -->
                        <div *ngIf="ibanError()" class="text-red-600 text-sm mt-1"><i class="pi pi-exclamation-triangle mr-1"></i>{{ ibanError() }}</div>
                    </div>

                    <!-- Name Geldinstitut -->
                    <div class="space-y-1">
                        <label for="name-geldinstitut" class="block text-sm font-medium text-gray-600">
                            {{ 'fuv.police.varianten.labels.nameGeldinstitut' | translate }}
                            <span class="text-xs text-gray-500 ml-2">({{ 'fuv.police.varianten.labels.wirdAutomatischAusgefuellt' | translate }})</span>
                        </label>
                        <input pInputText id="name-geldinstitut" [(ngModel)]="variantenData.name_bank" class="w-[600px] bg-gray-100 text-cyan-600" [disabled]="true" readonly />
                    </div>

                    <!-- PLZ, Ort -->
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-600">
                            {{ 'fuv.police.versichertePerson.plzOrt' | translate }}
                            <span class="text-xs text-gray-500 ml-2">({{ 'fuv.police.varianten.labels.wirdAutomatischAusgefuellt' | translate }})</span>
                        </label>
                        <div class="flex gap-2">
                            <input pInputText [(ngModel)]="variantenData.plz_bank" class="w-32 bg-gray-100" [disabled]="true" readonly />
                            <input pInputText [(ngModel)]="variantenData.ort_bank" class="w-[460px] bg-gray-100" [disabled]="true" readonly />
                        </div>
                    </div>

                    <!-- Kontoinhaber -->
                    <div class="space-y-1">
                        <label for="kontoinhaber" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.kontoinhaber' | translate }}</label>
                        <input pInputText id="kontoinhaber" [(ngModel)]="variantenData.kontoinhaber" class="w-[600px] text-cyan-600" (ngModelChange)="onDataChange()" autocomplete="off" [disabled]="viewMode" />
                    </div>
                </div>
            </div>

            <!-- Begleitschreiben -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold mb-4">{{ 'fuv.police.varianten.labels.begleitschreiben' | translate }}</h3>
                <div class="grid grid-cols-3 items-center">
                    <label class="text-sm font-medium text-gray-600">{{ 'fuv.police.varianten.labels.istBegleitschreibenVorhanden' | translate }}</label>
                    <div class="flex justify-center">
                        <p-selectButton [options]="begleitschreibenOptions" [(ngModel)]="variantenData.begleitbrief" optionLabel="label" optionValue="value" (onChange)="onDataChange()" [disabled]="viewMode"></p-selectButton>
                    </div>
                    <div></div>
                </div>
            </div>
        </div>
    </p-panel>
</div>
