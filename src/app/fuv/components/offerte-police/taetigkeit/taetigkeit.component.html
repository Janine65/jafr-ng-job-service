<div class="w-full">
    <p-panel header="{{ 'fuv.police.steps.taetigkeit' | translate }}" [toggleable]="false">
        <!-- Combined correction notification -->
        <div *ngIf="showDateCorrectionNotification || showAvbCorrectionNotification" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
            <div class="flex items-start gap-3">
                <i class="pi pi-info-circle text-blue-600 text-xl mt-0.5"></i>
                <div class="flex-1">
                    <!-- Auto-Correction notifications -->
                    <p class="text-sm font-semibold text-blue-800 mb-2">{{ 'fuv.police.taetigkeit.corrections.title' | translate }}</p>
                    <ul class="text-sm text-blue-700 space-y-2 list-none">
                        <li *ngIf="showDateCorrectionNotification" class="flex items-start gap-2">
                            <i class="pi pi-check text-blue-600 mt-0.5"></i>
                            <div>
                                <span class="font-medium">{{ 'fuv.police.taetigkeit.corrections.dateCorrected' | translate }}</span>
                                {{ 'fuv.police.taetigkeit.corrections.dateCorrectedDetail' | translate }}
                                <span *ngIf="correctedEndDate" class="block mt-1 text-blue-600">{{ 'fuv.police.taetigkeit.corrections.previousValue' | translate: { value: correctedEndDate } }}</span>
                            </div>
                        </li>
                        <li *ngIf="showAvbCorrectionNotification" class="flex items-start gap-2">
                            <i class="pi pi-check text-blue-600 mt-0.5"></i>
                            <div>
                                <span class="font-medium">{{ 'fuv.police.taetigkeit.corrections.avbUpdated' | translate }}</span>
                                {{ 'fuv.police.taetigkeit.corrections.avbUpdatedDetail' | translate }}
                                <span *ngIf="correctedAvb" class="block mt-1 text-blue-600">{{ 'fuv.police.taetigkeit.corrections.previousVersion' | translate: { version: (correctedAvb | codeLabel | async) } }}</span>
                            </div>
                        </li>
                    </ul>
                </div>
                <button type="button" class="text-blue-600 hover:text-blue-800 focus:outline-none" (click)="dismissAllCorrectionNotifications()" [attr.aria-label]="'common.actions.close' | translate">
                    <i class="pi pi-times text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Validation error banner -->
        <div #validationErrorBanner *ngIf="showValidation() && validationErrors.size > 0" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
            <div class="flex items-start gap-3">
                <i class="pi pi-exclamation-triangle text-red-600 text-xl mt-0.5"></i>
                <div>
                    <p class="text-sm font-semibold text-red-800 mb-1">{{ 'fuv.police.taetigkeit.validation.requiredFields' | translate }}</p>
                    <ul class="text-sm text-red-700 list-disc list-inside space-y-1">
                        <li *ngIf="hasError('vertragGueltigAb')">{{ (getFieldError('vertragGueltigAb') | translate) || ('fuv.police.taetigkeit.fields.vertragGueltigAb' | translate) }}</li>
                        <li *ngIf="hasError('vertragGueltigBis')">{{ (getFieldError('vertragGueltigBis') | translate) || ('fuv.police.taetigkeit.fields.vertragGueltigBis' | translate) }}</li>
                        <li *ngIf="hasError('vertragsdauer')">{{ (getFieldError('vertragsdauer') | translate) || ('fuv.police.taetigkeit.fields.vertragsdauer' | translate) }}</li>
                        <li *ngIf="hasError('verkaufskanal')">{{ (getFieldError('verkaufskanal') | translate) || ('fuv.police.taetigkeit.fields.verkaufskanal' | translate) }}</li>
                        <li *ngIf="hasError('taetigkeitsbeschreibung')">{{ (getFieldError('taetigkeitsbeschreibung') | translate) || ('fuv.police.taetigkeit.fields.taetigkeitsbeschreibung' | translate) }}</li>
                        <li *ngIf="hasError('stellungImBetrieb')">{{ (getFieldError('stellungImBetrieb') | translate) || ('fuv.police.taetigkeit.fields.stellungImBetrieb' | translate) }}</li>
                        <li *ngIf="hasError('arbeitspensum')">{{ (getFieldError('arbeitspensum') | translate) || ('fuv.police.taetigkeit.fields.arbeitspensum' | translate) }}</li>
                        <li *ngIf="hasError('taetigkeiten')">{{ (getFieldError('taetigkeiten') | translate) || ('fuv.police.taetigkeit.fields.taetigkeiten' | translate) }}</li>
                        <li *ngIf="hasError('selbststaendigSeit') && !isVerlaengerungView()">{{ (getFieldError('selbststaendigSeit') | translate) || ('fuv.police.taetigkeit.fields.selbststaendigSeit' | translate) }}</li>
                        <li *ngIf="hasError('anzahlMitarbeiter')">{{ (getFieldError('anzahlMitarbeiter') | translate) || ('fuv.police.taetigkeit.fields.anzahlMitarbeiter' | translate) }}</li>
                        <li *ngIf="hasError('stellenprozente')">{{ (getFieldError('stellenprozente') | translate) || ('fuv.police.taetigkeit.fields.stellenprozente' | translate) }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tätigkeit form data -->
        <div class="space-y-6">
            <!-- Vertragsdetails -->
            <div class="grid grid-cols-2 gap-24">
                <!-- Left column: Vertragsbeginn, Vertrag gültig bis, Dauer -->
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label for="vertrag-gueltig-ab" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.vertragGueltigAb' | translate }}</label>
                        <p-datepicker
                            id="vertrag-gueltig-ab"
                            [(ngModel)]="vertragGueltigAb"
                            dateFormat="dd.mm.yy"
                            [placeholder]="'fuv.police.taetigkeit.placeholders.datumWaehlen' | translate"
                            [fluid]="true"
                            [showIcon]="true"
                            iconDisplay="input"
                            [disabled]="isReadOnly()"
                            [invalid]="hasError('vertragGueltigAb') || isFieldEmpty('vertragGueltigAb')"
                            [ngClass]="{ '!border-orange-500': isFieldEmpty('vertragGueltigAb') }"
                            (onSelect)="onVertragGueltigAbChange()"
                        >
                            <ng-template #inputicon>
                                <i
                                    class="pi pi-calendar-plus cursor-pointer"
                                    (click)="setVertragGueltigAbToToday()"
                                    [pTooltip]="'fuv.police.taetigkeit.tooltips.setTodayDate' | translate"
                                    tooltipPosition="top"
                                    [class.text-gray-400]="isReadOnly()"
                                    [class.cursor-not-allowed]="isReadOnly()"
                                ></i>
                            </ng-template>
                        </p-datepicker>
                    </div>
                    <div class="space-y-1">
                        <label for="vertrag-gueltig-bis" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.vertragGueltigBis' | translate }}</label>
                        <p-datepicker
                            id="vertrag-gueltig-bis"
                            [(ngModel)]="vertragGueltigBis"
                            dateFormat="dd.mm.yy"
                            [placeholder]="'fuv.police.taetigkeit.placeholders.datumWaehlen' | translate"
                            [fluid]="true"
                            [disabled]="isReadOnly()"
                            [invalid]="hasError('vertragGueltigBis') || isFieldEmpty('vertragGueltigBis')"
                            [ngClass]="{ '!border-orange-500': isFieldEmpty('vertragGueltigBis') }"
                            (onSelect)="onVertragGueltigBisChange()"
                        >
                        </p-datepicker>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-600">{{ 'common.police.dauerDesVertrages' | translate }}</label>
                        <p-select
                            [options]="vertragsdauerOptions()"
                            optionLabel="label"
                            optionValue="value"
                            [(ngModel)]="taetigkeitData.vertragsdauer"
                            [placeholder]="'fuv.police.taetigkeit.placeholders.vertragsdauerWaehlen' | translate"
                            [fluid]="true"
                            [disabled]="isReadOnly()"
                            [invalid]="hasError('vertragsdauer') || isFieldEmpty('vertragsdauer')"
                            [ngClass]="{ '!border-orange-500': isFieldEmpty('vertragsdauer') }"
                            (onChange)="onVertragsdauerChange()"
                        >
                        </p-select>
                    </div>
                </div>

                <!-- Right column: AVB, Verkaufskanal -->
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label for="avb" class="block text-sm font-medium text-gray-500">{{ 'fuv.police.taetigkeit.avb' | translate }}</label>
                        <input pInputText id="avb" [value]="(currentOfferte()?.avb | codeLabel | async) || '-'" [fluid]="true" [disabled]="true" class="bg-gray-100" />
                    </div>
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.verkaufskanal' | translate }}</label>
                        <p-select
                            [options]="verkaufskanalOptions()"
                            optionLabel="label"
                            optionValue="value"
                            [(ngModel)]="taetigkeitData.verkaufskanal"
                            (onChange)="onVerkaufskanalChange()"
                            [placeholder]="'fuv.police.taetigkeit.placeholders.verkaufskanalWaehlen' | translate"
                            [fluid]="true"
                            [disabled]="isReadOnly()"
                            [invalid]="hasError('verkaufskanal')"
                        >
                        </p-select>
                    </div>
                </div>
            </div>

            <!-- Tätigkeitsbeschreibung -->
            <div class="border-t pt-6">
                <div class="space-y-1">
                    <label for="taetigkeitsbeschreibung" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.taetigkeitsbeschreibung' | translate }}</label>
                    <textarea
                        id="taetigkeitsbeschreibung"
                        [(ngModel)]="taetigkeitData.taetigkeitsbeschreibung"
                        rows="4"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.taetigkeitsbeschreibungErgaenzen' | translate"
                        class="w-full p-3 border rounded-md text-sm"
                        [disabled]="isReadOnly()"
                        [ngClass]="{
                            '!border-red-500': showValidation() && hasError('taetigkeitsbeschreibung'),
                            '!border-orange-500': !hasError('taetigkeitsbeschreibung') && isFieldEmpty('taetigkeitsbeschreibung')
                        }"
                        (ngModelChange)="onTaetigkeitsbeschreibungChange()"
                    >
                    </textarea>
                    <p *ngIf="hasError('taetigkeitsbeschreibung')" class="text-xs text-red-600 mt-1">{{ getFieldError('taetigkeitsbeschreibung') | translate }}</p>
                </div>
            </div>

            <!-- Stellung im Betrieb, Arbeitspensum -->
            <div class="grid grid-cols-2 gap-8">
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-gray-600">{{ 'common.partner.stellung' | translate }}</label>
                    <p-select
                        [options]="stellungOptions()"
                        optionLabel="label"
                        optionValue="value"
                        [(ngModel)]="taetigkeitData.stellungImBetrieb"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.stellungWaehlen' | translate"
                        [fluid]="true"
                        [disabled]="isReadOnly()"
                        [invalid]="hasError('stellungImBetrieb') || isFieldEmpty('stellungImBetrieb')"
                        [ngClass]="{ '!border-orange-500': isFieldEmpty('stellungImBetrieb') }"
                        (onChange)="onStellungImBetriebChange()"
                    >
                    </p-select>
                </div>
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.arbeitspensum' | translate }}</label>
                    <p-select
                        [options]="arbeitspensumOptions()"
                        optionLabel="label"
                        optionValue="value"
                        [(ngModel)]="taetigkeitData.arbeitspensum"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.arbeitspensumWaehlen' | translate"
                        [fluid]="true"
                        [disabled]="isReadOnly()"
                        [invalid]="hasError('arbeitspensum') || isFieldEmpty('arbeitspensum')"
                        [ngClass]="{ '!border-orange-500': isFieldEmpty('arbeitspensum') }"
                        (onChange)="onArbeitspensumChange()"
                    >
                    </p-select>
                </div>
            </div>

            <!-- Tätigkeiten -->
            <div class="border-t pt-6 border-b pb-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.taetigkeitenLabel' | translate }}</label>
                        <p class="text-xs text-gray-500 italic">{{ 'fuv.police.taetigkeit.taetigkeitenNote' | translate }}</p>
                    </div>
                    <div *ngFor="let item of taetigkeitData.taetigkeiten; let i = index; trackBy: trackByIndex" class="flex gap-4 items-center">
                        <p-autocomplete
                            [ngModel]="getTaetigkeitOption(item.taetigkeit)"
                            [suggestions]="filteredTaetigkeiten[i] || []"
                            (completeMethod)="filterTaetigkeiten($event, i)"
                            (ngModelChange)="onTaetigkeitSelected(i, $event?.value ?? $event)"
                            (onSelect)="onTaetigkeitSelected(i, $event.value)"
                            (onClear)="onTaetigkeitCleared(i)"
                            optionLabel="label"
                            dataKey="value"
                            [dropdown]="true"
                            [placeholder]="'fuv.police.taetigkeit.placeholders.taetigkeitSuchen' | translate"
                            [forceSelection]="true"
                            [showClear]="true"
                            [disabled]="isReadOnly()"
                            styleClass="flex-1"
                            [ngClass]="{
                                '!border-red-500': (showValidation() && hasError('taetigkeiten')) || !item.taetigkeit,
                                '!border-orange-500': !hasError('taetigkeiten') && !item.taetigkeit
                            }"
                        >
                            <ng-template let-option pTemplate="item">
                                {{ option.label }}
                            </ng-template>
                        </p-autocomplete>
                        <input
                            pInputText
                            [(ngModel)]="item.prozent"
                            class="w-20"
                            [disabled]="isReadOnly()"
                            (ngModelChange)="onTaetigkeitPercentChange(i, $event)"
                            [ngClass]="{
                                '!border-red-500': showValidation() && hasError('taetigkeiten'),
                                '!border-orange-500': !hasError('taetigkeiten') && (!item.prozent || item.prozent === '' || item.prozent === '0')
                            }"
                            placeholder="100 %"
                        />
                        <p-button icon="pi pi-minus" severity="secondary" [outlined]="true" [disabled]="isReadOnly() || taetigkeitenList.length === 1" (click)="removeTaetigkeit(i)"> </p-button>
                        <p-button icon="pi pi-plus" severity="secondary" [outlined]="true" [disabled]="isReadOnly()" (click)="addTaetigkeit()"> </p-button>
                    </div>
                    <div class="text-right font-semibold" [ngClass]="getTaetigkeitenTotalPercentageClass()">{{ 'fuv.offerte.detail.fields.total' | translate }}: {{ getTaetigkeitenTotalPercentage() }} %</div>
                </div>
            </div>

            <!-- Mitarbeiterverhältnisse -->
            <div class="grid grid-cols-3 gap-8">
                <!-- Hide "Seit wann sind Sie selbstständig" field for Verlängerung -->
                <div class="space-y-1" *ngIf="!isVerlaengerungView()">
                    <label for="selbststaendig-seit" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.selbststaendigSeit' | translate }}</label>
                    <p-datepicker
                        id="selbststaendig-seit"
                        [(ngModel)]="selbststaendigSeit"
                        dateFormat="dd.mm.yy"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.datumWaehlen' | translate"
                        [fluid]="true"
                        [disabled]="isReadOnly()"
                        [invalid]="hasError('selbststaendigSeit') || isFieldEmpty('selbststaendigSeit')"
                        [ngClass]="{ '!border-orange-500': isFieldEmpty('selbststaendigSeit') }"
                    >
                    </p-datepicker>
                </div>

                <div class="space-y-1">
                    <label class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.anzahlMitarbeiter' | translate }}</label>
                    <p-select
                        [options]="mitarbeiterOptions()"
                        optionLabel="label"
                        optionValue="value"
                        [(ngModel)]="taetigkeitData.anzahlMitarbeiter"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.anzahlMitarbeiterWaehlen' | translate"
                        [fluid]="true"
                        [disabled]="isReadOnly()"
                        [invalid]="hasError('anzahlMitarbeiter') || isFieldEmpty('anzahlMitarbeiter')"
                        [ngClass]="{ '!border-orange-500': isFieldEmpty('anzahlMitarbeiter') }"
                        (onChange)="onAnzahlMitarbeiterChange()"
                    >
                    </p-select>
                </div>

                <div class="space-y-1">
                    <label for="stellenprozente" class="block text-sm font-medium text-gray-600">{{ 'fuv.police.taetigkeit.fields.stellenprozente' | translate }}</label>
                    <input
                        pInputText
                        id="stellenprozente"
                        [(ngModel)]="stellenprozenteValue"
                        [placeholder]="'fuv.police.taetigkeit.placeholders.stellenprozenteErgaenzen' | translate"
                        [fluid]="true"
                        [disabled]="isReadOnly()"
                        [ngClass]="{
                            '!border-red-500': showValidation() && hasError('stellenprozente'),
                            '!border-orange-500': !hasError('stellenprozente') && isFieldEmpty('stellenprozente')
                        }"
                    />
                </div>
            </div>

            <!-- Information Angaben -->
            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                <p class="text-sm text-blue-800">{{ 'fuv.police.taetigkeit.fields.informationAngaben' | translate }}</p>
            </div>
        </div>
    </p-panel>
</div>
